process.env.NODE_TLS_REJECT_UNAUTHORIZED="0";import"./config.js";import{createRequire as o}from"module";import e,{join as n}from"path";import{fileURLToPath as l,pathToFileURL as a}from"url";import{platform as t}from"process";global.__filename=function filename(o=import.meta.url,e="win32"!==t){return e?/file:\/\/\//.test(o)?l(o):o:a(o).toString()},global.__dirname=function dirname(o){return e.dirname(global.__filename(o,!0))},global.__require=function require(e=import.meta.url){return o(e)};import*as r from"ws";import{readdirSync as s,statSync as i,unlinkSync as c,existsSync as g,readFileSync as p,watch as d}from"fs";import b from"yargs";import{spawn as m}from"child_process";import u from"lodash";import{clear as f}from"console";import h from"cfonts";import w from"syntax-error";import*as k from"os";import v from"chalk";import{format as P}from"util";import{makeWASocket as _,protoType as y,serialize as A}from"./lib/simple.js";import{Low as D,JSONFile as T}from"lowdb";import I from"pino";import U from"readline";import{mongoDB as j,mongoDBV2 as E}from"./lib/mongoDB.js";import{clearsession as $,connectionUpdate as O,createConnection as R}from"./lib/connection.js";const{CONNECTING:S}=r,{chain:x}=u;process.env.PORT||process.env.SERVER_PORT;y(),A(),global.API=(o,e="/",n={},l)=>(o in global.APIs?global.APIs[o]:o)+e+(n||l?"?"+new URLSearchParams(Object.entries({...n,...l?{[l]:global.APIKeys[o in global.APIs?global.APIs[o]:o]}:{}})):""),global.timestamp={start:new Date};const q=global.__dirname(import.meta.url);global.opts=new Object(b(process.argv.slice(2)).exitProcess(!1).parse()),global.prefix=new RegExp("^["+(opts.prefix||"â€ŽxzXZ/i!#$%+Â£Â¢â‚¬Â¥^Â°=Â¶âˆ†Ã—Ã·Ï€âˆšâœ“Â©Â�?:;?&.\\-").replace(/[|\\{}()[\]^$+*?.\-\^]/g,"\\$&")+"]"),global.db=new D(/https?:\/\//.test(opts.db||"")?new cloudDBAdapter(opts.db):/mongodb(\+srv)?:\/\//i.test(opts.db)?opts.mongodbv2?new E(opts.db):new j(opts.db):new T((opts._[0]?opts._[0]+"_":"")+"database.json")),global.loadDatabase=async function loadDatabase(){if(global.db.READ)return new Promise((o=>setInterval((async function(){global.db.READ||(clearInterval(this),o(null==global.db.data?global.loadDatabase():global.db.data))}),1e3)));null===global.db.data&&(global.db.READ=!0,await global.db.read()["catch"](console.error),global.db.READ=null,global.db.data={users:{},chats:{},stats:{},msgs:{},banned:{},sticker:{},settings:{},...global.db.data||{}},global.db.chain=x(global.db.data))},await loadDatabase(),global.authFile=`${opts._[0]||"sessions"}`,console.log(`Load AuthFile from ${authFile}`);const{connectionOptions:N,state:C,saveCreds:W}=await R(global.authFile,global.opts);global.conn=await _(N),conn.isInit=!1,opts.test||setInterval((async()=>{global.db.data&&await global.db.write()["catch"](console.error)}),6e4),process.on("uncaughtException",console.error);let B=!0,F=await import("./handler.js");global.reloadHandler=async function(o){try{const o=await import(`./handler.js?update=${Date.now()}`)["catch"](console.error);Object.keys(o||{}).length&&(F=o)}catch(e){console.error(e)}if(o){const o=global.conn.chats;try{global.conn.ws.close()}catch{}conn.ev.removeAllListeners(),global.conn=_(N,{chats:o}),B=!0}return B||(conn.ev.off("messages.upsert",conn.handler),conn.ev.off("group-participants.update",conn.participantsUpdate),conn.ev.off("groups.update",conn.groupsUpdate),conn.ev.off("message.delete",conn.onDelete),conn.ev.off("connection.update",conn.connectionUpdate),conn.ev.off("creds.update",conn.credsUpdate)),conn.welcome="*@user*\n*𝚑𝚊𝚜 𝚓𝚘𝚒𝚗𝚎𝚍 𝚝𝚑𝚎 𝚐𝚛𝚘𝚞𝚙*\n\n𝙱𝚎𝚏𝚘𝚛𝚎 �𝚑𝚊𝚝, 𝚍𝚘𝚗𝚝 �𝚘𝚛𝚐𝚎𝚝 𝚝𝚘 𝚛𝚎𝚊𝚍 𝚝𝚑𝚎 𝚐𝚛𝚘𝚞𝚙 𝚛𝚞𝚕𝚎𝚜",conn.bye="*@user* *𝚑𝚊𝚜 𝚕𝚎𝚏𝚝 𝚝𝚑𝚎 𝚐𝚛𝚘𝚞𝚙*",conn.spromote="@user sekarang admin!",conn.sdemote="@user sekarang bukan admin!",conn.sDesc="Deskripsi telah diubah ke \n@desc",conn.sSubject="Judul grup telah diubah ke \n@subject",conn.sIcon="Icon grup telah diubah!",conn.sRevoke="Link group telah diubah ke \n@revoke",conn.handler=F.handler.bind(global.conn),conn.participantsUpdate=F.participantsUpdate.bind(global.conn),conn.groupsUpdate=F.groupsUpdate.bind(global.conn),conn.onDelete=F.deleteUpdate.bind(global.conn),conn.connectionUpdate=o=>O(o,conn),conn.credsUpdate=W.bind(global.conn),conn.ev.on("messages.upsert",conn.handler),conn.ev.on("group-participants.update",conn.participantsUpdate),conn.ev.on("groups.update",conn.groupsUpdate),conn.ev.on("message.delete",conn.onDelete),conn.ev.on("connection.update",conn.connectionUpdate),conn.ev.on("creds.update",conn.credsUpdate),B=!1,!0};const H=global.__dirname(n(q,"./plugins/index")),pluginFilter=o=>/\.js$/.test(o);if(global.plugins={},async function filesInit(){for(let e of s(H).filter(pluginFilter))try{let o=global.__filename(n(H,e));const l=await import(o);global.plugins[e]=l["default"]||l}catch(o){conn.logger.error(o),delete global.plugins[e]}}().then((o=>{const e=Object.keys(global.plugins).length;console.log(v.bold.green(`Plugins Total : ${e} Plugins`))}))["catch"](console.error),global.reload=async(o,e)=>{if(pluginFilter(e)){let o=global.__filename(n(H,e),!0);if(e in global.plugins){if(!g(o))return conn.logger.warn(`deleted plugin '${e}'`),delete global.plugins[e];conn.logger.info(`re - require plugin '${e}'`)}else conn.logger.info(`requiring new plugin '${e}'`);let a=w(p(o),e,{sourceType:"module",allowAwaitOutsideFunction:!0});if(a)conn.logger.error(`syntax error while loading '${e}'\n${P(a)}`);else try{const n=await import(`${global.__filename(o)}?update=${Date.now()}`);global.plugins[e]=n["default"]||n}catch(l){conn.logger.error(`error require plugin '${e}\n${P(l)}'`)}finally{global.plugins=Object.fromEntries(Object.entries(global.plugins).sort((([o],[e])=>o.localeCompare(e))))}}},Object.freeze(global.reload),d(H,global.reload),await global.reloadHandler(),!conn.authState.creds.registered){console.clear(),await new Promise((o=>setTimeout(o,1e3))),console.log(v.bold.green("==============================================")),console.log(v.bold.yellow("           AUTENTIKASI WHATSAPP BOT          ")),console.log(v.bold.green("=============================================="));const o=U.createInterface({input:process.stdin,output:process.stdout}),question=e=>new Promise((n=>o.question(e,n)));try{let e;for(;console.log(v.bold.white("\nMasukkan nomor WhatsApp (contoh: 6281234567890):")),e=await question(v.green("> ")),e=e.replace(/[^0-9]/g,""),!e.match(/^\d{10,}$/);)console.log(v.bold.red("\nFormat nomor salah! Gunakan format 6281234567890"));console.log(v.bold.blue("\nMembuat kode autentikasi...")),await new Promise((o=>setTimeout(o,3e3)));const n=await conn.requestPairingCode(e),l=n?.match(/.{1,4}/g)?.join("-")||n;console.clear(),console.log(v.bold.green("==============================================")),console.log(v.bold.yellow("           KODE AUTENTIKASI WHATSAPP          ")),console.log(v.bold.green("==============================================")),console.log(v.bold.white("\nNomor: ")+v.cyan(e)),console.log(v.bold.white("Kode : ")+v.yellow.bold(l)),console.log(v.bold.green("\nCara menggunakan:")),console.log(v.white("1. Pastikan nomor WhatsApp sudah aktif")),console.log(v.white("2. Buka WhatsApp di ponsel Anda")),console.log(v.white("3. Buka Pengaturan → Perangkat Tertaut")),console.log(v.white("4. Pilih 'Tautkan Perangkat'")),console.log(v.white("5. Masukkan kode di atas dalam waktu 3 menit")),console.log(v.bold.green("\n==============================================")),conn.ev.on("connection.update",(e=>{"open"===e.connection&&(clearTimeout(timeout),console.log(v.green("\nBerhasil terhubung!")),o.close(),resolve())}))}catch(K){console.error(v.red("\nError saat autentikasi:",K))}finally{o.close()}}(async function _quickTest(){let o=await Promise.all([m("ffmpeg"),m("ffprobe"),m("ffmpeg",["-hide_banner","-loglevel","error","-filter_complex","color","-frames:v","1","-f","webp","-"]),m("convert"),m("magick"),m("gm"),m("find",["--version"])].map((o=>Promise.race([new Promise((e=>{o.on("close",(o=>{e(127!==o)}))})),new Promise((e=>{o.on("error",(o=>e(!1)))}))])))),[e,n,l,a,t,r,s]=o,i=global.support={ffmpeg:e,ffprobe:n,ffmpegWebp:l,convert:a,magick:t,gm:r,find:s};Object.freeze(global.support),i.ffmpeg||conn.logger.warn("Please install ffmpeg for sending videos (pkg install ffmpeg)"),i.ffmpeg&&!i.ffmpegWebp&&conn.logger.warn("Stickers may not animated without libwebp on ffmpeg (--enable-ibwebp while compiling ffmpeg)"),i.convert||i.magick||i.gm||conn.logger.warn("Stickers may not work without imagemagick if libwebp on ffmpeg doesnt isntalled (pkg install imagemagick)")})().then((()=>conn.logger.info("☑️ Quick Test Done")))["catch"](console.error);
